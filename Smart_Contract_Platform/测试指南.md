# 智慧合同管理平台 - 测试指南

## 一、环境准备

### 1.1 启动后端

```bash
cd backend
python -m venv .venv
# Windows: .venv\Scripts\activate
# macOS/Linux: source .venv/bin/activate
pip install -r requirements.txt
python -m app.db.init_db
uvicorn app.main:app --reload --port 8000
```

**验证**：访问 http://localhost:8000/docs 查看 Swagger 文档

### 1.2 启动前端

```bash
cd frontend
npm install
npm run dev
```

**验证**：访问 http://localhost:5173 看到登录页面

### 1.3 预置测试账号

| 角色 | 用户名 | 密码 | 级别 | 说明 |
|------|--------|------|------|------|
| 发包方合同管理员 | owner_contract | Owner123! | - | 创建合同、提交审核 |
| 发包方财务 | owner_finance | Finance123! | - | 审核支付申请 |
| 发包方法务 | owner_legal | Legal123! | - | 审核合同 |
| 发包方领导（局长） | owner_leader | Leader123! | BUREAU_CHIEF | 审批变更申请 |
| 发包方领导（处长） | owner_leader_director | Director123! | DIRECTOR | 审批变更申请 |
| 发包方领导（科长） | owner_leader_section | Section123! | SECTION_CHIEF | 审批变更申请 |
| 承包方 | contractor | Contractor123! | - | 提交变更/支付申请 |
| 监理 | supervisor | Supervisor123! | - | 录入完工比例 |
| 审计 | auditor | Auditor123! | - | 查看审计日志 |
| 系统管理员 | admin | Admin123! | - | 全部权限 |

---

## 二、功能测试步骤

### 任务1：弹窗功能验证

#### 测试步骤

1. **测试合同保存页面弹窗**
   - 使用 `owner_contract` 登录
   - 点击"新建合同"
   - 填写合同信息（注意：合同价必须等于中标价）
   - **测试场景1**：正常保存
     - 确保合同价 = 中标价
     - 点击"保存"
     - ✅ 应显示成功提示："已创建"
     - ✅ 页面跳转到合同详情页
     - ✅ 刷新页面后，合同确实已创建
   - **测试场景2**：合同价≠中标价
     - 设置合同价 ≠ 中标价（如：中标价1000万，合同价1001万）
     - 点击"保存"
     - ✅ 应显示错误提示："合同价必须与中标价一致"
     - ✅ 刷新页面后，合同**未创建**（数据库中不存在）

2. **测试变更申请提交页面弹窗**
   - 使用 `contractor` 登录
   - 进入一个 `ACTIVE` 状态的合同详情页
   - 在"变更"标签页点击"发起变更"
   - **测试场景1**：正常提交
     - 填写完整的变更信息（金额、原因、范围描述）
     - 点击"提交"
     - ✅ 应显示成功提示："已提交变更申请"
     - ✅ 对话框关闭
     - ✅ 刷新页面后，变更申请确实已创建
   - **测试场景2**：必填字段缺失
     - 不填写变更原因，点击"提交"
     - ✅ 应显示错误提示："请输入变更原因"
     - ✅ 刷新页面后，变更申请**未创建**
   - **测试场景3**：金额无效
     - 设置金额为0或负数，点击"提交"
     - ✅ 应显示错误提示："请输入有效的变更金额"
     - ✅ 刷新页面后，变更申请**未创建**

#### 预期结果
- 成功操作：弹窗提示成功，刷新后数据确实保存
- 失败操作：弹窗提示错误，刷新后数据未保存
- 弹窗提示与实际操作结果一致

---

### 任务2：合同字段修改（条款、期限时间）

#### 测试步骤

1. **登录发包方合同管理员** (`owner_contract` / `Owner123!`)

2. **创建合同**
   - 点击"新建合同"
   - 填写基本信息：
     - 合同号：`HT-TEST-001`
     - 合同名称：`测试合同`
     - 项目名称：`测试项目`
     - 发包方：`发包方A`
     - 承包方：选择已有承包方
   - **测试新字段**：
     - 合同开始日期：选择 `2025-01-01`
     - 合同结束日期：选择 `2025-12-31`
     - 详细条款：输入测试条款内容
   - 填写金额信息（中标价=合同价）
   - 点击"保存"

3. **验证**
   - ✅ 合同创建成功
   - ✅ 在合同详情页能看到开始/结束日期
   - ✅ 在合同详情页能看到详细条款
   - ✅ 可以编辑条款（草稿状态）

#### 预期结果
- 合同创建成功，所有字段正确保存
- 合同详情页正确显示日期和条款
- 可以编辑条款内容

---

### 任务3：法务审核合同

#### 测试步骤

1. **提交合同审核**
   - 使用 `owner_contract` 登录
   - 进入刚创建的合同详情页
   - 点击"提交给法务审核"

2. **验证通知**
   - 切换到通知页面（首页）
   - ✅ 应看到"新的合同待法务审核"通知

3. **法务审核**
   - 使用 `owner_legal` 登录
   - 进入"合同审核"页面（或 FinanceReview 页面的"合同审核"标签）
   - ✅ 应看到待审核的合同
   - 点击"查看详情"查看合同信息
   - 点击"审核通过"

4. **验证结果**
   - ✅ 合同状态变为 `ACTIVE`
   - ✅ 合同管理员收到"合同审核通过"通知
   - ✅ 合同详情页显示"法务审核通过"状态

5. **测试驳回流程**
   - 创建新合同并提交
   - 法务登录，点击"驳回"
   - 输入驳回原因：`合同条款不符合规范`
   - ✅ 合同状态退回 `DRAFT`
   - ✅ 合同管理员收到驳回通知

#### 预期结果
- 合同提交后进入 `APPROVING` 状态
- 法务能看到待审核合同列表
- 审核通过后合同变为 `ACTIVE`
- 驳回后合同退回 `DRAFT` 并通知创建人

---

### 任务4：支付申请流程修正

#### 测试步骤

1. **创建支付申请**
   - 使用 `contractor` 登录
   - 进入一个 `ACTIVE` 状态的合同详情页
   - 在"进度款"标签页点击"提交支付申请"
   - 填写金额、用途等信息
   - 提交

2. **验证流程**
   - ✅ 支付申请状态应为 `FINANCE_REVIEW`（不是 `SUBMITTED`）
   - ✅ 通知应发给财务（`owner_finance`），不是合同管理员

3. **财务审核**
   - 使用 `owner_finance` 登录
   - 进入"审核（合同/财务）"页面
   - ✅ 在"待财务审核"标签页应看到支付申请
   - ✅ **不应**在"待合同审核"标签页看到（该标签页应已移除或为空）

#### 预期结果
- 支付申请直接进入财务审核，不经过合同审核
- 财务能直接看到待审核的支付申请
- 通知正确发送给财务

---

### 任务5：Leader分级审批

#### 测试步骤

1. **创建变更申请**
   - 使用 `contractor` 登录
   - 进入一个 `ACTIVE` 状态的合同详情页
   - 在"变更"标签页提交变更申请
   - 填写变更金额（测试不同金额触发不同审批层级）：
     - **测试1**：金额 `30000` 元（≤5万）→ 应触发：科员 → 科长
     - **测试2**：金额 `150000` 元（≤20万）→ 应触发：科员 → 科长 → 处长
     - **测试3**：金额 `800000` 元（≤100万）→ 应触发：科员 → 科长 → 处长 → 局长

2. **验证审批任务**
   - 查看变更详情，应能看到审批任务列表
   - ✅ 每个任务显示步骤名称和所需级别

3. **测试科长审批**
   - 使用 `owner_leader_section`（科长）登录
   - 进入"审核（合同/财务）"页面
   - 在"变更申请审核"标签页应看到待审核的变更
   - ✅ 显示"所需级别：科长"
   - 点击"通过"，输入审核意见（可选）
   - ✅ 审批成功

4. **测试处长审批**
   - 使用 `owner_leader_director`（处长）登录
   - 在"变更申请审核"标签页应看到待审核的变更
   - ✅ 显示"所需级别：处长"
   - 点击"通过"

5. **测试局长审批**
   - 使用 `owner_leader`（局长）登录
   - 在"变更申请审核"标签页应看到待审核的变更
   - ✅ 显示"所需级别：局长"
   - 点击"通过"

6. **验证权限控制**
   - 使用科长账号尝试审批需要处长级别的任务
   - ✅ 应提示权限不足或级别不匹配

7. **测试驳回**
   - 任意审批人点击"驳回"
   - 输入驳回原因
   - ✅ 变更状态变为 `REJECTED`
   - ✅ 创建人收到驳回通知

#### 预期结果
- 不同金额自动匹配正确的审批层级
- 每个审批人只能看到和审批自己级别的任务
- 审批流程按顺序进行
- 全部通过后变更状态变为 `APPROVED`

---

### 任务6：监理描述字段必填

#### 测试步骤

1. **录入完工比例（无描述）**
   - 使用 `supervisor` 登录
   - 进入合同详情页的"完工比例"标签
   - 点击"录入完工比例"
   - 填写期次和完工比例
   - **不填写描述**，直接提交
   - ✅ 应提示错误：描述内容为必填

2. **录入完工比例（有描述）**
   - 填写描述内容：`本月完成基础工程，进度正常`
   - 提交
   - ✅ 提交成功
   - ✅ 列表中显示描述内容

#### 预期结果
- 描述字段为必填，未填写时无法提交
- 提交成功后描述内容正确显示

---

### 任务7：财务超额拦截

#### 测试步骤

1. **准备测试数据**
   - 确保合同有批复概算和完工比例
   - 计算可申请最大金额：`批复概算 × 完工比例 - 已支付累计`

2. **提交超额支付申请**
   - 使用 `contractor` 登录
   - 提交支付申请，金额**大于**可申请最大金额
   - 例如：可申请最大金额为 `100000`，申请 `150000`

3. **财务审核（超额拦截）**
   - 使用 `owner_finance` 登录
   - 进入"待财务审核"标签页
   - ✅ 应看到该支付申请
   - ✅ 应显示 `is_blocked: true` 或拦截标识
   - 点击"通过并支付"
   - ✅ 应弹出错误提示：`被拦截：申请金额超出可申请最大金额...`
   - ✅ 支付申请**仍在**"待财务审核"列表中（状态仍为 `FINANCE_REVIEW`）

4. **驳回超额申请**
   - 点击"驳回"
   - ✅ 应弹出输入框要求输入驳回理由
   - 输入理由：`申请金额超出可申请额度`
   - 确认驳回
   - ✅ 支付申请状态变为 `REJECTED`
   - ✅ 驳回理由正确保存

5. **正常支付申请**
   - 提交金额**小于等于**可申请最大金额的支付申请
   - 财务审核通过
   - ✅ 支付成功，状态变为 `PAID`
   - ✅ 合同已支付累计正确更新

#### 预期结果
- 超额申请被拦截但仍在列表中显示
- 拦截时显示详细原因
- 可以输入驳回理由并驳回
- 正常申请可以成功支付

---

### 任务8：数据查询

#### 测试步骤

1. **按合同号搜索**
   - 使用任意账号登录
   - 进入"合同"页面
   - 在搜索框输入合同号（部分或完整）：`HT-TEST`
   - ✅ 应显示匹配的合同

2. **按合同名称搜索**
   - 在搜索框输入合同名称（部分或完整）：`测试`
   - ✅ 应显示匹配的合同

3. **组合搜索**
   - 清空搜索框，重新输入
   - ✅ 搜索功能正常工作

#### 预期结果
- 支持按合同号和名称模糊搜索
- 搜索结果实时更新
- 搜索框可以清空

---

### 任务9：通知首页

#### 测试步骤

1. **验证首页**
   - 登录任意账号
   - ✅ 默认进入"首页通知"页面（不是 Dashboard）
   - ✅ 看到通知列表

2. **测试通知功能**
   - 执行各种操作（创建合同、提交审核、审批等）
   - 刷新通知页面
   - ✅ 应看到相关通知
   - ✅ 未读通知有标识
   - 点击"标为已读"
   - ✅ 通知状态更新

3. **验证通知内容**
   - ✅ 通知包含时间、标题、内容
   - ✅ 通知内容准确反映操作结果

#### 预期结果
- 登录后默认进入通知页面
- 通知正确生成和显示
- 可以标记已读

---

## 三、集成测试场景

### 场景1：完整合同流程

1. **合同管理员**创建合同（包含条款、日期）
2. **合同管理员**提交给法务审核
3. **法务**审核通过，合同生效
4. **承包方**提交变更申请（金额触发多级审批）
5. **科长**审批通过
6. **处长**审批通过
7. **局长**审批通过，变更生效
8. **监理**录入完工比例（含描述）
9. **承包方**提交支付申请
10. **财务**审核支付（测试正常和超额两种情况）

### 场景2：驳回流程

1. **合同管理员**创建并提交合同
2. **法务**驳回合同（输入驳回原因）
3. **合同管理员**修改合同后重新提交
4. **法务**审核通过

### 场景3：权限测试

1. 使用不同角色登录
2. 验证每个角色只能看到和操作有权限的功能
3. 验证 Leader 分级审批的权限控制

---

## 四、常见问题排查

### 问题1：数据库初始化失败
**解决**：删除 `backend/demo.db`，重新运行 `python -m app.db.init_db`

### 问题2：前端无法连接后端
**检查**：
- 后端是否在 `http://localhost:8000` 运行
- 前端 `.env` 或 `vite.config.js` 中的 API 地址配置

### 问题3：登录失败
**检查**：
- 用户名和密码是否正确
- 数据库是否已初始化
- 用户是否已创建

### 问题4：权限不足错误
**检查**：
- 当前登录用户的角色
- 操作所需角色权限
- Leader 用户的级别设置

---

## 五、测试检查清单

### 后端功能
- [ ] 合同字段（条款、日期）保存和读取
- [ ] 法务审核接口正常工作
- [ ] 支付申请直接进入财务审核
- [ ] Leader 分级审批逻辑正确
- [ ] 监理描述字段必填验证
- [ ] 财务超额拦截逻辑正确
- [ ] 数据查询接口正常
- [ ] 通知系统正常工作

### 前端功能
- [ ] 合同创建表单显示新字段
- [ ] 合同详情显示和编辑条款
- [ ] 法务审核页面正常显示
- [ ] 支付申请流程正确
- [ ] Leader 审批界面正常
- [ ] 监理描述字段必填提示
- [ ] 财务超额拦截显示和驳回
- [ ] 搜索功能正常
- [ ] 通知首页为默认页面

### 数据一致性
- [ ] 合同状态流转正确
- [ ] 支付金额计算准确
- [ ] 审批流程状态正确
- [ ] 通知内容准确

---

## 六、测试数据建议

### 测试合同
- 合同1：小金额变更（≤5万）
- 合同2：中金额变更（≤20万）
- 合同3：大金额变更（≤100万）
- 合同4：超大金额变更（>100万）

### 测试支付
- 正常支付：金额在可申请范围内
- 超额支付：金额超出可申请范围
- 边界测试：金额等于可申请最大金额

---

## 七、性能测试（可选）

1. **批量数据测试**
   - 创建 100+ 合同
   - 测试搜索性能
   - 测试列表加载速度

2. **并发测试**
   - 多用户同时操作
   - 测试审批流程并发

---

## 八、测试报告模板

### 测试结果记录

| 功能 | 测试用例 | 预期结果 | 实际结果 | 状态 | 备注 |
|------|---------|---------|---------|------|------|
| 任务2 | 创建合同带条款和日期 | 成功保存 | | | |
| 任务3 | 法务审核通过 | 合同生效 | | | |
| 任务4 | 支付申请流程 | 直接到财务 | | | |
| 任务5 | Leader分级审批 | 按级别审批 | | | |
| 任务6 | 监理描述必填 | 必填验证 | | | |
| 任务7 | 财务超额拦截 | 拦截并显示 | | | |
| 任务8 | 数据查询 | 搜索正常 | | | |
| 任务9 | 通知首页 | 默认首页 | | | |

---

**测试完成后，请记录所有发现的问题和异常情况，以便后续修复。**

