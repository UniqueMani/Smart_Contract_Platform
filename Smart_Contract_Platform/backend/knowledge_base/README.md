# AI知识库文档

[![ChromaDB](https://img.shields.io/badge/ChromaDB-0.4+-blue.svg)](https://www.trychroma.com/)
[![LangChain](https://img.shields.io/badge/LangChain-0.1+-green.svg)](https://www.langchain.com/)

AI合同审查功能的知识库，基于 RAG（检索增强生成）技术，存储法律文档的向量化表示。

## 目录

- [概述](#概述)
- [目录结构](#目录结构)
- [使用方法](#使用方法)
- [技术架构](#技术架构)
- [维护更新](#维护更新)
- [故障排查](#故障排查)

## 概述

知识库用于存储法律文档的向量化表示，支持 AI 合同审查功能的智能检索。系统使用 ChromaDB 作为向量数据库，通过 LangChain 进行文档处理和检索。

### 功能特性

- **文档存储**: 支持 PDF 格式的法律文档
- **向量化**: 自动将文档转换为向量表示
- **智能检索**: 基于语义相似度的文档检索
- **增量更新**: 支持新增文档而不影响已有数据

## 目录结构

```
knowledge_base/
├── pdfs/              # PDF文档目录
│   ├── 中华人民共和国合同法_19990315.pdf
│   ├── 中华人民共和国招标投标法_20171227.pdf
│   ├── 中华人民共和国政府采购法_20140831.pdf
│   ├── 建设工程施工合同（示范文本）》.pdf
│   ├── 建设工程质量管理条例_20190423.pdf
│   └── 最高人民法院关于审理建设工程施工合同纠纷案件适用法律问题的解释（一）_20201229.pdf
├── chroma_db/         # ChromaDB向量数据库（自动生成）
│   ├── chroma.sqlite3
│   └── [collection_id]/
│       ├── data_level0.bin
│       ├── header.bin
│       └── ...
└── README.md          # 本文档
```

## 使用方法

### 1. 准备PDF文档

将需要添加到知识库的PDF文件放入 `pdfs/` 目录。

**要求**：
- PDF文件必须是可读的文本PDF（不是扫描版图片）
- 文件命名建议使用中文名称，便于识别
- 支持多个PDF文件，系统会自动处理所有文件

### 2. 初始化知识库

运行初始化脚本：

```bash
cd backend
python scripts/init_knowledge_base.py
```

脚本会执行以下操作：

1. 扫描 `pdfs/` 目录下的所有PDF文件
2. 提取PDF文本内容
3. 将文本分割为适合检索的块（chunks）
4. 生成向量嵌入（embeddings）
5. 存储到ChromaDB向量数据库

### 3. 验证知识库

初始化完成后，可以通过以下方式验证：

- 检查 `chroma_db/` 目录是否生成
- 查看脚本输出的处理结果
- 使用AI审查功能测试检索效果

## 技术架构

### 技术栈

- **ChromaDB**: 向量数据库，用于存储和检索文档向量
- **LangChain**: 文档处理和检索框架
- **Sentence Transformers**: 文本嵌入模型（可选）
- **PyPDF2**: PDF文本提取

### 工作流程

```
PDF文档
  ↓
文本提取 (PyPDF2)
  ↓
文本分块 (RecursiveCharacterTextSplitter)
  ↓
向量化 (Sentence Transformers / ChromaDB默认)
  ↓
存储到ChromaDB
  ↓
检索时：查询向量化 → 相似度搜索 → 返回相关文档块
```

### 文档分块策略

- **块大小**: 800字符
- **重叠**: 150字符
- **分块方式**: 递归字符分割

### 向量化模型

系统支持两种向量化方式：

1. **本地模型**（推荐）: 使用 Sentence Transformers
   - 模型: `sentence-transformers/all-MiniLM-L6-v2`
   - 优点: 无需API调用，响应快
   - 缺点: 首次需要下载模型

2. **ChromaDB默认**: 使用ChromaDB内置嵌入
   - 优点: 无需额外配置
   - 缺点: 性能可能不如专用模型

## 维护更新

### 添加新文档

1. 将新的PDF文件放入 `pdfs/` 目录
2. 运行初始化脚本：

```bash
python scripts/init_knowledge_base.py
```

脚本会自动检测新文件并处理，已处理的文件不会重复处理。

### 更新已有文档

如果需要更新已有文档：

1. 删除 `chroma_db/` 目录
2. 更新 `pdfs/` 目录中的PDF文件
3. 重新运行初始化脚本

### 删除文档

1. 从 `pdfs/` 目录删除PDF文件
2. 删除 `chroma_db/` 目录
3. 重新运行初始化脚本

**注意**: ChromaDB 不支持单独删除某个文档，需要重建整个知识库。

## 故障排查

### 问题1: PDF解析失败

**症状**: 脚本提示"PDF解析失败"

**解决方案**:
- 确认PDF文件是文本PDF（不是扫描图片）
- 检查PDF文件是否损坏
- 尝试使用其他PDF阅读器打开文件验证

### 问题2: 嵌入模型加载失败

**症状**: 提示"无法加载本地嵌入模型"

**解决方案**:
- 确认已安装 `sentence-transformers` 包
- 首次运行需要下载模型，请等待
- 如果网络问题，系统会自动使用ChromaDB默认嵌入

### 问题3: 知识库未找到

**症状**: AI审查时提示"未找到相关法律条款"

**解决方案**:
- 确认已运行初始化脚本
- 检查 `chroma_db/` 目录是否存在
- 重新运行初始化脚本

### 问题4: 检索结果不准确

**症状**: AI审查结果不相关

**解决方案**:
- 检查PDF文档质量（文本是否清晰）
- 确认文档内容与合同审查相关
- 尝试增加知识库中的文档数量
- 调整检索参数（top_k）

## 性能优化

### 提高检索准确性

1. **增加相关文档**: 添加更多与合同审查相关的法律文档
2. **优化文档质量**: 确保PDF文本清晰、格式规范
3. **调整分块大小**: 根据文档特点调整块大小和重叠

### 提高检索速度

1. **使用本地模型**: 避免API调用延迟
2. **优化向量维度**: 使用合适的嵌入模型
3. **限制检索数量**: 合理设置 top_k 参数

## 相关文档

- [AI审查功能使用说明](../AI审查功能使用说明.md)
- [初始化脚本文档](../scripts/README.md)
- [ChromaDB文档](https://docs.trychroma.com/)
- [LangChain文档](https://python.langchain.com/)

## 贡献

欢迎添加更多法律文档到知识库！

