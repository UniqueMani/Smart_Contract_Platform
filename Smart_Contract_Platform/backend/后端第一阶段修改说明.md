# 后端第一阶段修改说明

## 修改完成总结

### 任务2：合同字段修改（条款、期限时间）

**修改文件：**
- `backend/app/models/contract.py` - 添加 `clauses`、`start_date`、`end_date` 字段
- `backend/app/schemas/contract.py` - 在三个 Schema 中添加新字段
- `backend/app/api/routers/contracts.py` - 在创建和更新函数中处理新字段

### 任务5：Leader分级审批（方案A）

**修改文件：**
- `backend/app/models/user.py` - 添加 `level` 字段
- `backend/app/models/change.py` - 在 `ChangeApprovalTask` 中添加 `required_level` 字段
- `backend/app/services/workflow.py` - 修改审批规则，返回级别信息
- `backend/app/api/routers/changes.py` - 添加级别检查逻辑
- `backend/app/schemas/change.py` - 在 `ChangeTaskOut` 中添加 `required_level` 字段
- `backend/app/db/init_db.py` - 更新测试用户，添加不同级别的领导用户

### 任务7：财务超额拦截改进

**修改文件：**
- `backend/app/models/payment.py` - 添加 `is_blocked` 和 `reject_reason` 字段
- `backend/app/schemas/payment.py` - 添加对应字段和 `PaymentReject` Schema
- `backend/app/api/routers/payments.py` - 修改审批和驳回逻辑

### 任务8：数据查询（合同号和名称）

**修改文件：**
- `backend/app/crud/crud_contract.py` - 在 `contract_list` 函数中添加查询参数
- `backend/app/api/routers/contracts.py` - 在 `list_contracts` 接口中添加查询参数

## 重要提示

### 数据库迁移

由于修改了模型，需要重新初始化数据库：

```bash
cd backend
python -m app.db.init_db
```

**注意**：这会删除旧的 `demo.db` 并创建新的数据库结构。

### 新增测试账号（任务5）

- `owner_leader_section` / `Section123!` - 科长级别
- `owner_leader_director` / `Director123!` - 处长级别
- `owner_leader` / `Leader123!` - 局长级别（已存在，已更新级别）

### API 变更

1. **合同查询接口**：现在支持 `contract_no` 和 `contract_name` 查询参数
2. **支付驳回接口**：现在需要 `PaymentReject` 参数（包含 `reject_reason`）
3. **变更审批任务**：现在包含 `required_level` 字段

## 状态

✅ 所有修改已完成，代码已通过 linter 检查。可以重新初始化数据库并测试功能。
